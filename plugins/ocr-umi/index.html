<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>OCR 识别（Umi-OCR）</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: file:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">
  <style>
    :root { --bg:#ffffff; --fg:#222; --panel:#ffffff; --border:#e5e7eb; --muted:#666; --media:#0b0d10; --accent:#3b82f6; --scrollbar-thumb: rgba(0,0,0,0.2); --scrollbar-track: transparent; }
    html, body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--fg); font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; }
    .wrap { position:absolute; inset:0; display:flex; gap:12px; padding:12px; box-sizing:border-box; }
    .col { flex:1; display:flex; flex-direction:column; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--panel); box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .viewer { flex:1; display:flex; align-items:center; justify-content:center; background:var(--media); }
    .viewer img { max-width:100%; max-height:100%; object-fit:contain; display:block; }
    .tools { padding:10px; display:flex; gap:8px; align-items:center; justify-content:space-between; border-top:1px solid var(--border); background:var(--panel); }
    .btn { height:32px; padding:0 12px; border:1px solid var(--border); border-radius:8px; background:var(--panel); color:var(--fg); cursor:pointer; font-size:12px; transition:all .15s ease; }
    .btn:hover { background:var(--accent); color:#fff; border-color:var(--accent); }
    .text { flex:1; padding:12px; overflow:auto; white-space:pre-wrap; word-break:break-word; font-size:14px; line-height:1.6; }
    .status { font-size:12px; color:var(--muted); }
    .error { color:#dc3545; }
    ::-webkit-scrollbar { width:10px; height:10px; }
    ::-webkit-scrollbar-thumb { background:var(--scrollbar-thumb); border-radius:6px; border:2px solid transparent; background-clip:content-box; }
    ::-webkit-scrollbar-track { background:var(--scrollbar-track); }
  </style>
  <script>
    const api = window.MT;
    // 主题适配：跟随主程序主题，动态设置 CSS 变量
    (function(){
      function applyTheme(effective){
        try {
          const root = document.documentElement;
          if (effective === 'dark'){
            root.style.setProperty('--bg', '#0f1113');
            root.style.setProperty('--panel', '#1b1d21');
            root.style.setProperty('--fg', '#e6e7ea');
            root.style.setProperty('--border', '#2a2c32');
            root.style.setProperty('--muted', '#a0a0a0');
            root.style.setProperty('--media', '#0b0d10');
            root.style.setProperty('--scrollbar-thumb', 'rgba(255,255,255,0.25)');
            root.style.setProperty('--scrollbar-track', 'rgba(255,255,255,0.06)');
          } else {
            root.style.setProperty('--bg', '#ffffff');
            root.style.setProperty('--panel', '#ffffff');
            root.style.setProperty('--fg', '#222222');
            root.style.setProperty('--border', '#e5e7eb');
            root.style.setProperty('--muted', '#666666');
            root.style.setProperty('--media', '#f3f4f6');
            root.style.setProperty('--scrollbar-thumb', 'rgba(0,0,0,0.2)');
            root.style.setProperty('--scrollbar-track', 'transparent');
          }
        } catch {}
      }
      (async () => {
        try { const t = await api.invoke('ui.getTheme'); applyTheme((t && t.effective) || 'light'); } catch {}
      })();
      window.addEventListener('mt-theme-change', (ev)=>{
        try { applyTheme((ev && ev.detail && ev.detail.effective) || 'light'); } catch {}
      });
    })();
    let lastInput = null; // { type: 'file'|'dataUrl', value: string }
    let running = false;

    function setStatus(msg, isError=false) {
      try {
        const el = document.getElementById('status');
        if (!el) return;
        el.textContent = msg || '';
        el.className = 'status' + (isError ? ' error' : '');
      } catch {}
    }
    function setImage(src) {
      try { const img = document.getElementById('preview'); if (img) img.src = src || ''; } catch {}
    }
    function setText(t) {
      try { const el = document.getElementById('result'); if (el) el.textContent = t || ''; } catch {}
    }
    // 仍需 file:// URL 以便预览本地图片
    function toFileUrl(p) { return 'file:///' + String(p||'').replace(/\\/g,'/').replace(/^\/+/, ''); }

    // RapidOCR 不需要 Umi-OCR 的 CLI 选项，保持空数组或不传入

    async function doOCR() {
      if (!lastInput || running) return;
      running = true;
      setStatus('识别中...', false);
      setText('');

      try {
        const payload = lastInput.type === 'file'
          ? { sourceType: 'file', path: lastInput.value }
          : { sourceType: 'dataUrl', dataUrl: lastInput.value };

        const data = await api.invoke('ocr.rapid', payload);
        const text = (data && data.text) || '';
        setText(text || '(未识别到文字)');
        setStatus('完成');
      } catch (e) {
        setStatus('识别异常：' + (e && e.message || e), true);
      } finally { running = false; }
    }

    function bindUI() {
      try {
        const btnRe = document.getElementById('btnReOcr');
        const btnCopy = document.getElementById('btnCopy');
        if (btnRe) btnRe.addEventListener('click', doOCR);
        if (btnCopy) btnCopy.addEventListener('click', async () => {
          const t = (document.getElementById('result')||{}).textContent || '';
          await api.invoke('clipboard.writeText', t);
          setStatus('已复制');
        });
      } catch {}
    }

    // 通过受限 API 注册输入事件（插件预加载会把 IPC 转发到此回调）
    if (api && typeof api.onInput === 'function') {
      api.onInput((d) => {
        try {
          const raw = String((d && d.content) || '');
          if (raw.startsWith('[CLIPBOARD-IMAGE]')) {
            const dataUrl = raw.replace('[CLIPBOARD-IMAGE]', '');
            lastInput = { type: 'dataUrl', value: dataUrl };
            setImage(dataUrl);
          } else if (raw) {
            lastInput = { type: 'file', value: raw };
            setImage(toFileUrl(raw));
          } else {
            setStatus('未收到输入', true);
            return;
          }
          setStatus('识别中...');
          doOCR();
        } catch (e) {
          setStatus('处理输入异常：' + (e && e.message || e), true);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', bindUI);
  </script>
  
</head>
<body>
  <div class="wrap">
    <div class="col">
      <div class="viewer"><img id="preview" alt="preview"/></div>
      <div class="tools">
        <button class="btn" id="btnReOcr">重新识别</button>
      </div>
    </div>
    <div class="col">
      <div class="text" id="result"></div>
      <div class="tools">
        <span class="status" id="status">等待输入...</span>
        <button class="btn" id="btnCopy">复制全部</button>
      </div>
    </div>
  </div>
</body>
</html>


