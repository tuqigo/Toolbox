## 打包与发布排障指南（Windows）

目标：汇总发布版常见问题与修复方法，提供稳定可复用的检查清单，避免“本地运行正常，打包后异常”。

### 一、快速结论（必看）

- 运行时依赖必须显式加入打包白名单，否则发布版会提示“agent modules not found”或隐式回退 DIRECT。
- 本地 CA/数据目录路径不能重复拼接子目录，确保 CA 实际生成位置与检测一致，否则浏览器会报 ERR_CERT_AUTHORITY_INVALID。
- 证书判定应以“SHA1 指纹”严格匹配，且安装前先删除旧的同名 CA，避免旧证书残留导致不受信。
- 系统代理广播可能失败（InternetSetOption => FAIL），但注册表已生效；必要时手动切换系统代理或重启浏览器。
- 只有 PAC 命中的请求才会进入本代理；未命中返回 DIRECT，不会链式到上游。
- 看到“只打印了‘生产日志已启用’就退出”的场景，多为“第二实例被拒绝（single-instance lock）”。

---

### 二、打包配置要点（package.json）

1) files 白名单（发布必含）

```json
{
  "build": {
    "files": [
      "node_modules/http-mitm-proxy/package.json",
      "node_modules/http-mitm-proxy/dist/**/*",
      "node_modules/http-proxy-agent/**/*",
      "node_modules/https-proxy-agent/**/*",
      "node_modules/socks-proxy-agent/**/*",
      "node_modules/agent-base/**/*",
      "node_modules/debug/**/*",
      "node_modules/ms/**/*",
      "node_modules/proxy-from-env/**/*",
      "node_modules/socks/**/*",
      "node_modules/smart-buffer/**/*",
      "node_modules/ip/**/*"
    ]
  }
}
```

2) asarUnpack（原生模块）

```json
{
  "build": {
    "asar": true,
    "asarUnpack": [
      "node_modules/better-sqlite3/build/Release/*.node"
    ]
  }
}
```

3) 运行参数（用于排障）

- 发布版 EXE 可加 `--dev` 开关：启用更详细的控制台日志与 Renderer console-message 转发。

---

### 三、路径与目录（避免错位）

- 数据根目录：`baseDir = app.getPath('userData')/data`
- 抓包目录：`baseDir/capture`
- CA 目录：`baseDir/capture/ca`

注意：若主进程已通过 `options.getDataDir()` 传入 `.../data`，不要再额外拼接 `MiniToolbox/data`。否则会出现如：`.../data/MiniToolbox/data/...` 的重复路径，导致 CA 生成与检测不一致，进而触发浏览器证书不受信。

发布版启动时，日志应类似：

```
[CAPTURE] proxy started 127.0.0.1:8888 baseDir= C:\Users\<user>\AppData\Roaming\mini-toolbox\data caDir= C:\Users\<user>\AppData\Roaming\mini-toolbox\data\capture\ca
```

---

### 四、证书安装与判定（避免 ERR_CERT_AUTHORITY_INVALID）

- 判定规则：优先计算当前 CA 的 SHA1 指纹，并在 certutil 输出中严格匹配；若指纹不匹配则判定为未安装，避免误判旧 CA。
- 安装流程（Windows）：
  - 安装前先尝试删除旧的同名 CA：`certutil -user -delstore Root NodeMITMProxyCA`，必要时再删 `Node MITM Proxy CA`。
  - 然后 `certutil -user -addstore Root <ca.pem>`；失败再尝试机器根存储。
- 卸载流程（增强）：同时尝试删除 `NodeMITMProxyCA` 与 `Node MITM Proxy CA`，覆盖不同版本库的命名差异。
- 浏览器仍报不受信：
  - 打开“管理计算机证书”→ 当前用户 → 受信任的根证书颁发机构 → 证书，搜索 `NodeMITMProxyCA`；
  - 确保仅一份且指纹与日志/状态一致；
  - 完整重启浏览器（包括所有后台进程）。

常见错误：

- `net::ERR_CERT_AUTHORITY_INVALID` 或 `SSLV3_ALERT_CERTIFICATE_UNKNOWN`
  - 原因：未安装当前 CA、安装了旧 CA、或 CA 生成位置与检测不一致（路径错位）。
  - 处置：卸载旧 CA → 重新安装 → 重启浏览器；同时核对日志中的 `baseDir` 与 `caDir`。

---

### 五、系统代理与 PAC（入流开关）

- 全局模式：所有 HTTP(S) 默认进入本代理，最稳定。
- PAC 模式：仅命中 `targets`/`pathPrefixes` 的请求进入本代理；未命中 `DIRECT`（不会链式）。
- Windows 广播：`InternetSetOption` 可能返回 FAIL，但注册表已生效。若浏览器未即时刷新，手动开关“使用代理服务器”或重启浏览器。

---

### 六、链式上游（出流）

- 运行时依赖：`http-proxy-agent/https-proxy-agent/socks-proxy-agent` 及其传递依赖必须在发布包内（见“二、打包配置要点”）。
- 上游选择：`'system'`（从注册表解析）、或显式 `socks5://127.0.0.1:10808` / `http://127.0.0.1:10809`。
- 日志诊断：
  - `[CAPTURE][UPSTREAM] http=... https=... bypass=...`
  - `[CAPTURE][CHAIN][use] ... upstream=...` 表示已使用上游
  - `[CAPTURE][CHAIN][skip] upstream temporarily disabled ...` 表示熔断窗口内暂时跳过上游

常见错误：

- `agent modules not found`
  - 原因：白名单缺少传递依赖。
  - 处置：补齐 files 白名单，参考前文配置。

- 周期性 `ETIMEDOUT` 与短暂 DIRECT
  - 原因：上游瞬时不可达触发熔断（默认 15s），期间 DIRECT；
  - 处置：等待窗口结束或重启上游；必要时在 UI 关闭再开启链式。

---

### 七、单实例锁与最小日志

- 仅见“生产日志已启用 …”后进程退出：
  - 原因：`requestSingleInstanceLock()` 未获取到锁，当前进程被立即退出；
  - 处置：先退出旧实例（托盘退出或任务管理器结束），再启动发布版。

---

### 八、日志与定位

- 发布版日志目录：`%APPDATA%/mini-toolbox/logs`（例如 `C:\Users\<user>\AppData\Roaming\mini-toolbox\logs`）。
- 关键日志：
  - 启动：插件扫描、屏幕检测、`MiniToolbox 启动成功`、日志目录路径
  - 抓包：`[CAPTURE] proxy started ... baseDir= ... caDir= ...`
  - 证书：`[CAPTURE][CERT][check] {... fp: 'XXXX...' }`
  - 上游：`[CAPTURE][UPSTREAM] ...`、`[CHAIN][use]/[done]`、`[CHAIN][skip]`
  - 系统代理：`[CAPTURE][SYS-PROXY][enable][state] {...}`

---

### 九、打包前自检清单（开发机）

- [ ] `npm ci` 完成且无 peer 报错
- [ ] `npm run dev` 或 `npm start` 可稳定访问需要代理的网站
- [ ] `captureProxy` 日志显示 baseDir/caDir 正常（无重复子目录）
- [ ] 证书状态：安装正确、指纹一致；卸载/安装流程可反复成功
- [ ] 上游端口可达（如 `Test-NetConnection 127.0.0.1 -Port 10808`）
- [ ] PAC/全局切换生效（浏览器正确走代理）

---

### 十、发布后冒烟测试清单（目标机）

- [ ] 启动 EXE，确认“插件扫描/启动成功/日志目录”日志出现
- [ ] 抓包插件开启后：
  - [ ] `[CAPTURE] proxy started ... baseDir= ... caDir= ...` 正常
  - [ ] `[CAPTURE][UPSTREAM] ...` 已解析上游
  - [ ] 访问外网站点，出现 `[CHAIN][use]/[done] upstream=...`
  - [ ] 无 ERR_CERT_AUTHORITY_INVALID（若有：卸载旧 CA → 安装新 CA → 重启浏览器）

---

### 十一、常见报错对照表

- `agent modules not found`
  - 缺少传递依赖 → 补齐 files 白名单
- `net::ERR_CERT_AUTHORITY_INVALID` / `SSLV3_ALERT_CERTIFICATE_UNKNOWN`
  - 旧 CA 残留或路径错位 → 卸载旧 CA → 安装新 CA → 核对 baseDir/caDir → 重启浏览器
- 仅出现“生产日志已启用 …”
  - 第二实例 → 退出旧实例后重启
- `InternetSetOption broadcast => FAIL`
  - 正常现象（部分环境）→ 手动切换系统代理或重启浏览器
- 大量 `ETIMEDOUT` 与间歇 DIRECT
  - 上游不稳定或熔断窗口 → 等待窗口结束/复位上游/检查 10808/10809 端口

---

### 十二、CI/CD 与构建建议

- 在 CI 中执行：`npm ci` → `electron-builder`（portable 或 nsis）；
- 构建后自动执行“冒烟脚本”（可选）：启动 EXE + 检查日志包含关键行（proxy started / UPSTREAM）
- 产物与日志归档：将 `logs/` 与构建产物一并存档，回溯问题更高效。

---

### 十三、附：关键片段一览

- 依赖白名单：见“二、打包配置要点”。
- 原生模块解包：`asarUnpack` 需包含 better-sqlite3 的 `.node`。
- 目录判定与启动日志：启动输出 `baseDir` 与 `caDir`，用以快速确认证书目录正确。

---

如仍遇到发布版与本地行为不一致，请附带当天日志文件（`MiniToolbox-YYYYMMDD.log`）与 `[CAPTURE] proxy started ... baseDir=/caDir=` 那一行，一般可在 1–2 个往返内定位问题根因。


