## 背景与目标

- 实现系统级 HTTP/HTTPS 抓包能力（方案B：本地代理 + MITM）。
- 插件侧可安全控制：启动/停止代理、启用/禁用系统代理、安装证书、过滤与查看抓包数据、HAR 导出。
- 满足“即开即用”“自动清理无残留”“现代化 UI”“黑/白主题”和小屏优化。

## 整体架构

- 主进程服务：`src/core/captureProxy.js`
  - 基于 `http-mitm-proxy` 启动本地代理（默认 127.0.0.1:8888）。
  - 证书中心（CA）与按域名签发，支持 HTTPS 解密。
  - 目标域过滤（代理层）：仅命中域名/通配的请求才进入记录链路。
  - 记录链路：请求/响应头与正文（小体内联，大体落盘），支持 gzip/deflate/br 解压与 JSON 美化。
  - 系统代理开关（Windows HKCU）与状态查询（reg/PowerShell）。
  - 安全清理：停止代理、禁用系统代理（暴露 API 供插件/主进程退出时调用）。

- IPC 通道（统一网关 `mt.secure-call`，在 `src/main.js`）：
  - `capture.start` / `capture.stop` / `capture.status`（含系统代理状态与证书安装状态）
  - `capture.list` / `capture.detail` / `capture.clear` / `capture.exportHar`
  - `capture.installCert` / `capture.uninstallCert` / `capture.enableSystemProxy` / `capture.disableSystemProxy`

- 插件 UI：`plugins/http-sniffer`（`plugin.json`/`index.html`/`script.js`）
  - 顶部信息条（运行状态、证书状态、刷新/导出/清空/安装证书）。
  - 工具区（启动/停止、一键启用/禁用系统代理、端口与“目标域（抓包范围）”输入 + 应用）。
  - 列表区 + 详情区：支持方法/host/path/status 的查看层过滤；详情显示头与正文预览。
  - Toast 消息替代 alert（更友好），小屏下按钮仅显示 SVG，hover 显示提示。
  - 自动工作流：插件打开即启动代理并启用系统代理；关闭插件自动禁用系统代理并停止代理。

## 数据流与过滤策略

1. 浏览器/系统设置代理 → 流量经 127.0.0.1:端口 到主进程代理。
2. 代理在 CONNECT/Request 阶段根据“目标域（抓包范围）”做代理层过滤：
   - 支持 `example.com`（包含其子域）与 `*.example.com` 通配。
   - 命中才进入解密/记录链路；未命中直接透传（不入库、不耗资源）。
3. 记录链路：
   - 请求/响应头完整保存；正文按阈值内联或落盘（大体不阻塞 UI）。
   - 响应正文尝试解压（gzip/deflate/br）；按 Content-Type 猜测文本/JSON 并美化。
4. 查看层过滤在 `capture.list` 执行（方法/host/path/status），不影响已抓数据范围。

## 抓包数据存储位置

- 路径：`app.getPath('userData')/data/capture/`
  - CA/证书：`/ca/`（根证书 `ca.pem` 与每域证书）
  - 正文大体：`/bodies/`（请求 `id_req.bin`、响应 `id_resp.bin`）
  - 元数据：保存在主进程内存的环形缓冲（`this.records`），默认最多 2000 条（可配置）。

说明：
- 小体（默认 ≤256KB 且判定为文本）以内联字符串形式存在内存；大体仅落盘并在详情显示“(saved) 文件名”。
- HAR 导出按当前内存记录生成（不包含未入库的透传流量）。

## 证书与系统代理

- 证书：
  - 首次启动代理自动生成 CA 于 `data/capture/ca/`。
  - `capture.installCert`（Windows）将 CA 安装到“当前用户-受信任的根”，使用 `certutil`。
  - `capture.status` 返回 `certInstalled`（PowerShell/certutil 检测）。
  - 卸载：`capture.uninstallCert`（按 CN 尝试移除）。

- 系统代理（Windows）：
  - 启用/禁用通过 `reg.exe`（HKCU）+ PowerShell 兜底并广播 `InternetSetOption`。
  - 状态查询：`capture.status` → `proxyState`（enable/server/raw）。
  - 插件打开自动启用；插件关闭、应用退出自动禁用，避免残留。

## 安全与沙箱

- 插件与渲染进程仅通过 `window.MT.invoke('mt.secure-call', …)` 访问能力，不直连 Node/FS/Socket。
- 抓包服务位于主进程，统一权限与审计；日志打印包含关键步骤与失败原因，便于排障。
- 关闭插件/应用时强制清理系统代理与代理进程，确保不留残余配置与监听端口。

## UI/UX 要点

- 现代化配色、分组布局、SVG 图标与 hover 提示；黑暗主题滚动条自定义。
- 目标域（抓包范围）独立于列表过滤项，需点击“应用”以重启代理套用规则。
- 列表只做查看层筛选，不影响实际抓包范围与资源消耗。
- Toast 提示仅在手动操作或自动启动一次性提示；状态轮询不再弹窗。

## 注意事项与已知限制

- Windows 组策略可能限制 HKCU 注册表修改，导致系统代理启用失败（已提供 PowerShell 兜底与错误日志）。
- 部分站点启用 H2/H3 或强校验证书策略，可能提示不受信；需安装 CA 并重启浏览器。
- Node 代理普遍对 H2/H3 支持有限，可能降级到 HTTP/1.1；记得在 UI 提示该事实。
- 大体预览仍可能是二进制或特殊编码（比如 protobuf）；此类仅落盘不内联。

## 后续优化建议

- 主题/系统联动：结合 `ui.getTheme` 与 CSS 变量，支持明/暗自动切换与实时更新。
- 性能：
  - 列表虚拟化（万级记录不卡顿）。
  - 流式正文截断/懒加载与二次展开。
  - 更细粒度环形缓冲（分层索引；按 host/time 段分桶）。
- 更丰富的抓包层规则：方法/路径前缀/正则、忽略列表、最大包体限制等。
- 操作：请求重放、一键复制 cURL、规则化改写（Headers/Body）、限速/丢包模拟。
- 多平台系统代理：macOS（networksetup/SCPreferences）、Linux（gsettings/环境变量）。
- 证书管理：到期提醒、手动导出、按域名证书缓存策略可配置。
- 安全：敏感字段掩码（Authorization/Cookie/Token），可配置脱敏规则。

## 常见问题（FAQ）

- Q：为什么设置了目标域仍然没抓到？
  - A：目标域是代理层过滤，需点击“应用”以重启代理套用；且 `example.com` 会匹配其子域，`*.example.com` 仅匹配子域不含主域。

- Q：GET 请求的 body 为什么不是明文？
  - A：多数 GET 没有请求体；若有，请求体可能是二进制或被压缩/自定义编码。已对响应做 gzip/deflate/br 解压，对请求体默认直存。可根据 Content-Type 扩展请求体解压/美化策略。

- Q：抓到的数据在哪里？如何清空？
  - A：元数据在内存环形缓冲；大体在 `userData/data/capture/bodies/`。点击“清空”会清空内存记录并清空 bodies 目录。

## 关键路径索引

- 主进程入口与通道：`src/main.js`（`mt.secure-call` → `capture.*` 分发；应用退出清理）。
- 抓包服务：`src/core/captureProxy.js`（代理/证书/系统代理/存储/导出）。
- 插件 UI：`plugins/http-sniffer/`（`index.html` + `script.js`）。

## 日志与排障

- 关键日志前缀：
  - `[CAPTURE]` 代理启动与端口信息。
  - `[CAPTURE][SYS-PROXY]` 系统代理启用/禁用/广播结果。
  - `[CAPTURE][onError]` 代理底层错误回调。
- 若系统代理启用失败：检查 `reg.exe` 与 PowerShell 输出，可能需要手动在系统设置中打开/关闭一次代理以刷新。


